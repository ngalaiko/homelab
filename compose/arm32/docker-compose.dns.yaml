version: '3.4'

volumes:
    dnscrypt:

services:
    pihole:
        image: ngalayko/pihole:arm32v7
        environment:
            - ServerIP=${SERVER_IP}
            - VIRTUAL_HOST=dns.${HOST}
            - TZ=Europe/Stockholm
            - WEBPASSWORD=${DNS_PASSWORD}
        volumes:
            - /data/dns/pihole/:/etc/pihole/
            - /data/dns/dnsmasq.d/:/etc/dnsmasq.d/
        networks:
            - traefik
        deploy:
            replicas: 1
            placement:
                constraints:
                    - "node.labels.dns==true"
            restart_policy:
                condition: on-failure
            labels:
                - "traefik.docker.network=server_traefik"
                - "traefik.web.port=80"
                - "traefik.web.frontend.rule=Host:dns.${HOST}"

    doh-proxy:
        image: ngalayko/doh-proxy:arm32v7
        hostname: dns-over-https-proxy
        command:
            - "--upstream-resolver=pihole"
            - "--port=3000"
            - "--listen-address=0.0.0.0"
            - "--trusted"
        networks:
            - traefik
        deploy:
            replicas: 3
            restart_policy:
                condition: on-failure
            labels:
                - "traefik.docker.network=server_traefik"
                - "traefik.dns.port=3000"
                - "traefik.dns.frontend.rule=Host:connect.dns.${HOST}"
